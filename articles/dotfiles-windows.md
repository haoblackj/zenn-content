---
title: "Windows式年遷宮スクリプト"
emoji: "✨"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["windows", "dotfiles", "powershell", "wsl", "winget"]
published: false
---

# 概要
- Windows の式年遷宮には喜びが伴う
- Windows を手軽にクリーンインストールするためのスクリプトを用意した
- ソフトウェアのインストールと設定ファイルの配置を自動化する

# 目的
Windows を手軽にクリーンインストールできる状態にしたい。

手軽にクリーンインストールできる状態とは、最小限の利用停止時間かつ最小の手間で、正常かついつもどおりに Windows を使用可能な状態にできる方法が確立していることをいう。

Windows を使っていると、「なんかよくわからんけど動きが悪いな」ということがある。
ソフトウェアを入れすぎて、システムドライブの容量が足りなくなることもある。
最近のローカル LLM ブームに乗っかって `Anaconda` だの `pyenv` だの `Node.js` だのを考えなしに突っ込んで、環境が汚くなっていくこともある。

こういうときに、サクッと手軽にクリーンインストールできる状態が整っていれば、原因究明に時間をかけずに済む。
仕事でこんなことを言えばぶっ飛ばされるが、自宅に設置した自己所有端末の話だ。自分の支出で購入した物品であるから、何をとやかく言われることもない。
仮にぶっ壊れても、自分が泣くだけで済む話だ。

ちなみに、最近はこういう環境整備のことを式年遷宮というらしい。

:::message
手軽にクリーンインストールできるということは、検証用環境を手軽に構築できるということでもある。
仮想マシンだけではなかなか再現しづらい不具合があるときに、クリーンインストールできる環境があると、検証が捗る。

※個人の感想。
:::

# 方針
このスクリプトの方針は、極力手動操作を避けることである。

- ソフトウェアの手動インストール
  - インストーラーをダウンロード→ダブルクリック→次へ→(N 回)→完了
- 設定ファイルの手動配置
  - 設定ファイルをコピー→ディレクトリを開く→ペースト→(必要に応じて)OS 再起動
  ※変更したらバックアップしなければならない、も追加。

いかにも面倒くさい。
偉い人は言いました、3 回同じことをやるなら自動化しろと。

なので、自動化しました。

# Windowsのインストール
まずはインストールメディアを用意する。
用意するのは USB メモリ(16GB 以上)と、MediaCreationTool(Microsoft 公式が配布しているツール)である。

配布先は下記。
https://www.microsoft.com/ja-jp/software-download/windows11

このツールをダウンロードして、USB メモリを接続し、ツールを実行すれば、インストールメディアが手に入る。

だが、我々は Windows を手軽に再インストールしようというのだ。
叶うなら、Windows のインストール自体も自動化したい。
せめて、インストールするエディションの選択くらいは自動化しておいてほしい。
欲を言えば、インストールするビルドも指定したい。

:::message
Windows のインストール先を選択するのは手動とする。
物理ディスクが 1 本なら迷うことはない(最悪インストールメディアが吹っ飛ぶだけ)が、複数のディスクがある場合は、ディスクを取り違えると悲惨なことになる。
バックアップを取っているから平気? そのバックアップ、書き戻しテストはしましたか?
:::

なので、我々はこれを使う。
https://github.com/AveYo/MediaCreationTool.bat
このリポジトリを作業用 PC にクローンして、`MediaCreationTool.bat` を実行すると、いろいろな選択肢が出てくる。
詳しくは README を読んでほしいが、たとえば、BAT ファイルを `11_23h2 Pro ja-JP x64 usb MediaCreationTool.bat` とリネームして実行すると、`Windows 11 Pro エディション バージョン23H2、日本語、x64 ビルド` の USB インストールメディアが作成される。
:::message
自動で、とは言ったが、作成先の USB メモリは手動で選択しないといけない。
我慢できんという人は、自分で DISM なり何なりで作成してください。
:::
そして、この USB メモリの中に、下記ページの要領で設定ファイルを格納する。
https://learn.microsoft.com/ja-jp/windows-hardware/manufacture/desktop/windows-setup-edition-configuration-and-product-id-files--eicfg-and-pidtxt?view=windows-11

これで、ひとつ手動操作が減った。

:::message
上記ページにも記載があるとおり、`ei.cfg` と `pid.txt` でできる設定は、すべて無人応答ファイルでも可能だ。
ただ、この無人応答ファイルを真面目に作ろうとすると、Windows ADK をインストールして云々しなければならないし、さすがに動作検証が面倒くさい。
加えて、無人応答ファイルの設定の一部は、このあとで使うプロビジョニングパッケージの適用をスキップしてしまう場合がある。
なので、今回は手軽さを重視して、`ei.cfg` と `pid.txt` を使うことにした。
:::